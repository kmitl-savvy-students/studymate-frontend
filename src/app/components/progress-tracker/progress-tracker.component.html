<div class="my-6">
	<h1 class="text-xl font-semibold">ความคืบหน้าของการลงเรียนวิชาต่างๆ ตามโครงสร้างหลักสูตร</h1>
	<h3 class="text-sm opacity-50">คุณ {{ currentUser?.firstname }} {{ currentUser?.lastname }}</h3>
</div>
<div class="flex flex-col gap-y-6">
	<div *ngIf="currentUser?.curriculum?.curriculum_group" class="border-dark-50 max-w-full overflow-x-auto rounded-xl border p-6">
		<div data-accordion="collapse">
			<div class="mb-2 flex flex-wrap items-center gap-3">
				<button
					class="border-dark-50 flex w-full items-center gap-2 rounded-xl border px-4 py-2 font-medium hover:bg-gray-100"
					[attr.data-accordion-target]="'#group-' + currentUser?.curriculum?.curriculum_group?.id"
					(click)="toggleAccordion(currentUser?.curriculum?.curriculum_group?.id ?? -1)">
					<div class="flex w-full flex-row items-center justify-between gap-5">
						<!-- <div class="mr-3 h-8 w-2 rounded-xl bg-violet-200 align-middle"></div> -->
						<div class="flex flex-row items-center gap-5">
							<input type="checkbox" class="h-7 w-7 rounded-3xl accent-green-600" [checked]="groupComplete.get(currentUser?.curriculum?.curriculum_group?.id || -1)" disabled />
							<div class="text-left">
								<!-- <div class="font-semibold">โครงสร้างหลักสูตร</div> -->
								<div class="font-semibold">
									<span>{{ currentUser?.curriculum?.name_th }}</span
									><span> {{ currentUser?.curriculum?.year }}</span>
								</div>
								<div class="text-sm opacity-75">ประเภท: {{ currentUser?.curriculum?.curriculum_group?.type }}</div>
							</div>
						</div>
						<div class="flex flex-row items-center gap-5">
							<div class="text-sm text-gray-600">
								หน่วยกิตที่ได้รับ: {{ groupCreditUsed.get(currentUser?.curriculum?.curriculum_group?.id || -1) || 0 }} /
								{{ groupCreditRequired.get(currentUser?.curriculum?.curriculum_group?.id || -1) || 0 }}
							</div>
							<!-- <div
								class="transition-transform duration-200"
								[ngClass]="{
									'rotate-90': isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1),
								}">
								▶
							</div> -->
							<div
								class="text-gray-400 transition-transform duration-200"
								[ngClass]="{
									'rotate-90': isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1),
									'text-black': isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1),
								}">
								▶
							</div>
						</div>
					</div>
				</button>
			</div>

			<div [id]="'group-' + currentUser?.curriculum?.curriculum_group?.id" [class.hidden]="!isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1)" class="ml-16">
				<ng-container *ngTemplateOutlet="renderGroup; context: { $implicit: currentUser?.curriculum?.curriculum_group?.children, level: 6 }"></ng-container>
			</div>
		</div>
	</div>

	<ng-template #renderGroup let-node let-level="level">
		<ul>
			<li *ngFor="let child of node" class="mb-3">
				<!-- แก้เป็น sdm-accordion -->
				<div class="flex flex-wrap items-center gap-3">
					<button class="border-dark-50 flex w-full items-center gap-2 rounded-xl border px-4 py-2 font-medium hover:bg-gray-50" [attr.data-accordion-target]="'#group-' + child.id" (click)="toggleAccordion(child.id)">
						<div class="flex w-full flex-row items-center justify-between gap-5">
							<div class="flex flex-row items-center gap-5">
								<input type="checkbox" class="h-7 w-7 rounded-3xl accent-green-600" [checked]="groupComplete.get(child.id)" disabled />
								<div class="h-10 w-2 rounded-xl align-middle" [style.background-color]="child.color"></div>
								<div class="text-left">
									<div class="font-semibold">{{ child.name }}</div>
									<div class="text-sm opacity-75">ประเภท: {{ child.type }}</div>
								</div>
							</div>
							<div class="flex flex-row items-center gap-5">
								<div class="text-sm text-gray-600">
									หน่วยกิตที่ได้รับ: {{ groupCreditUsed.get(child.id) || 0 }} /
									{{ groupCreditRequired.get(child.id) || 0 }}
								</div>
								<!-- <span class="text-right transition-transform" [ngClass]="{ 'rotate-90': isAccordionOpen(child.id) }"> ▶ </span> -->
								<div
									class="text-gray-400 transition-transform duration-200"
									[ngClass]="{
										'rotate-90': isAccordionOpen(child.id),
										'text-black': isAccordionOpen(child.id),
									}">
									▶
								</div>
							</div>
						</div>
					</button>
				</div>
				<div [id]="'group-' + child.id" class="ml-4 mt-2 min-w-fit" [class.hidden]="!isAccordionOpen(child.id)" [style.padding-left.px]="level * 8">
					<ng-container *ngIf="groupMatches.get(child.id)?.length">
						<div class="border-dark-50 rounded-xl border px-2 py-6">
							<sdm-subject-list-card maxTextLength="max-w-52" [transcriptDetails]="groupMatches.get(child.id)" subjectLabelColor="{{ findParentNodeColor(child, node) }}"></sdm-subject-list-card>
							<div class="px-4 pt-3">
								<sdm-base-button
									text="ดูรายวิชาอื่นๆในหมวดหมู่นี้"
									backgroundColorCustom="{{ findParentNodeColor(child, node) }}"
									backgroundColorHover="hover:bg-primary-400"
									textColorHover="hover:text-gray-50"></sdm-base-button>
							</div>
						</div>
					</ng-container>
					<ng-container *ngTemplateOutlet="renderGroup; context: { $implicit: child.children, level: 6 }"></ng-container>
				</div>
			</li>
		</ul>
	</ng-template>
	<div class="flex h-24 w-full items-center justify-center rounded-xl bg-red-50 py-4 font-semibold text-red-500">* หมายเหตุ: รายวิชาที่ยังไม่อยู่ในกลุ่มใดจะถูกแสดงด้านล่าง</div>
	<div *ngIf="notFittedSubjects.length > 0">
		<h3 class="my-3 font-bold text-red-600">รายวิชาที่ยังไม่อยู่ในกลุ่มใด:</h3>
		<div class="border-dark-50 rounded-xl border px-2 py-6">
			<sdm-subject-list-card [transcriptDetails]="notFittedSubjects" subjectLabelColor="#FEF2F2"></sdm-subject-list-card>
		</div>
	</div>
</div>
