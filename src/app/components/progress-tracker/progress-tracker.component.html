<div class="my-6">
	<h1 class="text-xl font-semibold">ความคืบหน้าของการลงเรียนวิชาต่างๆ ตามโครงสร้างหลักสูตร</h1>
	<h3 class="text-sm opacity-50">คุณ {{ currentUser?.firstname }} {{ currentUser?.lastname }}</h3>
</div>

<div class="my-6">
	<label class="border-dark-50 inline-flex max-w-full cursor-pointer items-center overflow-x-auto rounded-xl border p-4">
		<input type="checkbox" class="peer sr-only" (change)="toggleIncludeXGrade()" [checked]="includeXGrade" />
		<div
			class="peer relative h-7 w-14 rounded-full bg-gray-200 after:absolute after:start-[4px] after:top-0.5 after:h-6 after:w-6 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rtl:peer-checked:after:-translate-x-full"></div>
		<span class="ms-3 text-sm font-medium text-main-75">แสดงข้อมูลรายวิชาที่ลงในเทอมปัจจุบัน</span>
	</label>
</div>

<div class="flex flex-col gap-y-6">
	<div *ngIf="currentUser?.curriculum?.curriculum_group" class="border-dark-50 max-w-full overflow-x-auto rounded-xl border p-6">
		<div data-accordion="collapse">
			<div class="mb-2 flex flex-wrap items-center gap-3">
				<button
					class="border-dark-50 flex w-full items-center gap-2 rounded-xl border px-4 py-2 font-medium hover:bg-gray-50"
					[attr.data-accordion-target]="'#group-' + currentUser?.curriculum?.curriculum_group?.id"
					(click)="toggleAccordion(currentUser?.curriculum?.curriculum_group?.id ?? -1)">
					<div class="flex w-full flex-row items-center justify-between gap-5">
						<div class="flex flex-row items-center gap-5">
							<input type="checkbox" class="h-7 w-7 rounded-3xl accent-green-600" [checked]="groupComplete.get(currentUser?.curriculum?.curriculum_group?.id || -1)" disabled />
							<div class="text-left">
								<div class="font-semibold">
									<span>{{ currentUser?.curriculum?.name_th }}</span>
									<span>{{ currentUser?.curriculum?.year }}</span>
								</div>
								<div class="text-sm opacity-75">
									ประเภท:
									{{ currentUser?.curriculum?.curriculum_group?.type }}
								</div>
							</div>
						</div>
						<div class="flex flex-row items-center gap-5">
							<sdm-total-credit-earn
								[isCollectCredit]="false"
								[Checked]="groupComplete.get(currentUser?.curriculum?.curriculum_group?.id || -1)"
								[earnCredit]="groupCreditUsed.get(currentUser?.curriculum?.curriculum_group?.id || -1) || 0"
								[totalCredit]="groupCreditRequired.get(currentUser?.curriculum?.curriculum_group?.id || -1) || 0"></sdm-total-credit-earn>
							<div
								class="transition-transform duration-200"
								[ngClass]="{
									'rotate-90': isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1),
									'text-black': isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1),
								}">
								▶
							</div>
						</div>
					</div>
				</button>
			</div>

			<div [id]="'group-' + currentUser?.curriculum?.curriculum_group?.id" [class.hidden]="!isAccordionOpen(currentUser?.curriculum?.curriculum_group?.id ?? -1)" class="ml-16">
				<ng-container
					*ngTemplateOutlet="
						renderGroup;
						context: {
							$implicit: currentUser?.curriculum?.curriculum_group?.children,
							level: 6,
						}
					"></ng-container>
			</div>
		</div>
	</div>

	<ng-template #renderGroup let-node let-level="level">
		<ul>
			<li *ngFor="let child of node" class="mb-3">
				<div class="flex flex-wrap items-center gap-3">
					<button class="border-dark-50 flex w-full items-center gap-2 rounded-xl border px-4 py-2 font-medium hover:bg-gray-50" [attr.data-accordion-target]="'#group-' + child.id" (click)="toggleAccordion(child.id)">
						<div class="flex w-full flex-row items-center justify-between gap-5">
							<div class="flex flex-row items-center gap-5">
								<input type="checkbox" class="h-7 w-7 rounded-3xl accent-green-600" [checked]="groupComplete.get(child.id)" disabled />
								<div class="h-10 w-2 rounded-xl align-middle" [style.background-color]="findParentNodeColor(child)"></div>
								<div class="text-left">
									<div class="font-semibold">
										{{ child.name }}
									</div>
									<div class="text-sm opacity-75">ประเภท: {{ child.type }}</div>
								</div>
							</div>
							<div class="flex flex-row items-center gap-5">
								<sdm-total-credit-earn
									[isCollectCredit]="child.type == 'COLLECTIVE'"
									[bgColor]="'#2563eb'"
									[Checked]="groupComplete.get(child.id)"
									[earnCredit]="groupCreditUsed.get(child.id) || 0"
									[totalCredit]="groupCreditRequired.get(child.id) || 0"></sdm-total-credit-earn>
								<div
									class="text-gray-500 transition-transform duration-200"
									[ngClass]="{
										'rotate-90': isAccordionOpen(child.id),
										'text-black': isAccordionOpen(child.id),
									}">
									▶
								</div>
							</div>
						</div>
					</button>
				</div>

				<div [id]="'group-' + child.id" class="ml-4 mt-2 min-w-fit overflow-hidden transition-all" [class.hidden]="!isAccordionOpen(child.id)" [style.padding-left.px]="level * 8">
					<ng-container *ngIf="groupMatches.get(child.id)?.length || child.subjects.length != 0">
						<div class="border-dark-50 rounded-xl border px-2 py-6">
							<sdm-subject-list-card maxTextLength="max-w-52" [transcriptDetails]="groupMatches.get(child.id)" [subjectLabelColor]="findParentNodeColor(child)"></sdm-subject-list-card>
							<ng-container *ngIf="child.type != 'FREE'">
								<div class="px-4 pt-3">
									<sdm-base-button
										text="ดูรายวิชาในหมวดหมู่นี้"
										[backgroundColorCustom]="findParentNodeColor(child)"
										backgroundColorHover="hover:bg-primary-400"
										textColorHover="hover:underline"
										(clickEvent)="onClickShowSubjectGroup(child.subjects, findParentNodeColor(child))"></sdm-base-button>
								</div>
							</ng-container>
						</div>
					</ng-container>
					<ng-container *ngTemplateOutlet="renderGroup; context: { $implicit: child.children, level: 6 }"></ng-container>
				</div>
			</li>
		</ul>
	</ng-template>
	<div class="flex h-24 w-full items-center justify-center rounded-xl bg-red-50 py-4 font-semibold text-red-500">* หมายเหตุ: รายวิชาที่ยังไม่อยู่ในกลุ่มใดจะถูกแสดงด้านล่าง</div>
	<div *ngIf="notFittedSubjects.length > 0">
		<h3 class="my-3 font-bold text-red-600">รายวิชาที่ยังไม่อยู่ในกลุ่มใด:</h3>
		<div class="border-dark-50 rounded-xl border px-2 py-6">
			<sdm-subject-list-card [transcriptDetails]="notFittedSubjects" subjectLabelColor="#FEF2F2"></sdm-subject-list-card>
		</div>
	</div>
</div>

<sdm-base-modal #showSubjectGroupModal modalId="showSubjectGroup" header="รายวิชาที่เกี่ยวข้อง" [normalModal]="true">
	<div class="mb-3 max-h-[500px] overflow-y-scroll">
		<div class="sticky top-0 z-10 flex w-full flex-col items-center justify-center bg-white pb-2">
			<div class="font-semibold">
				มีรายวิชาในหมวดนี้ทั้งหมด <span>{{ currentSubjects.length }}</span> รายวิชา
			</div>
		</div>
		<div class="flex flex-col gap-3 px-4">
			<ng-container *ngFor="let subject of currentSubjects">
				<a [href]="getSubjectDetailUrl(subject.subject?.id!)" target="_blank" class="border-dark-10 flex items-center justify-between rounded-xl border py-0.5 ps-5 text-lg transition-all hover:cursor-pointer hover:bg-main-10">
					<div class="flex flex-row p-2">
						<div class="mr-3 w-2 rounded-xl align-middle" [style.background-color]="currentSubjectsGroupColor"></div>
						<div class="flex flex-col">
							<div class="max-w-64 truncate text-base font-semibold">{{ subject.subject?.id }} {{ subject.subject?.name_th }}</div>
							<div class="text-xs opacity-50">
								{{ subject.subject?.name_en }}
							</div>
						</div>
					</div>
					<div class="flex gap-3">
						<div class="flex w-[150px] items-center gap-4 p-4">
							<span class="text-xs opacity-50">หน่วยกิต</span><span class="text-lg font-semibold text-main-100">{{ subject.subject?.credit }}</span>
						</div>
					</div>
				</a>
			</ng-container>
		</div>
	</div>
</sdm-base-modal>
